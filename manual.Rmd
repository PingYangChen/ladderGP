---
title: "Manual of Gaussian Process Modelling Functions for Ladder-shaped Input Data"
author: "Ping-Yang Chen"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: cosmo
    toc: yes
    toc_float:
      collapsed: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Data Preparation


考慮 $p$ 個因子的多階段實驗，$X^{(z)}_{j}$



若實驗執行一個階段，則
$x_i= (x^{(1)}_{1i}, x^{(1)}_{2i}, \ldots, x^{(1)}_{pi})$

若實驗執行兩個階段，則
$x_i= (x^{(1)}_{1i}, \ldots, x^{(1)}_{pi}, x^{(2)}_{1i}, \ldots, x^{(2)}_{pi})$

In a multi-stage experiment, there are $p$ factors. 


```{r loadex, echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
source('R/testfunction.R')
library(SFDesign)
```

```{r setdata, echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
p_data <- c(1, 2, 3)
n_train <- c(10, 10, 10)
n_test <- c(3, 3, 3)
```

```{r traindata, echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
xList <- lapply(1:length(p_data), function(k) {
  maxproLHD(n_train[k], p_data[k])$design
})

yList <- lapply(1:length(p_data), function(k) {
  tmp <- numeric(nrow(xList[[k]]))
  for (i in 1:nrow(xList[[k]])) {
    tmp[i] <- Rastrigin(xList[[k]][i,])
  }
  tmp
})
```

```{r testdata, echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}

x0List <- lapply(1:length(p_data), function(k) {
  maxproLHD(n_test[k], p_data[k])$design
})
y0List <- lapply(1:length(p_data), function(k) {
  tmp <- numeric(nrow(x0List[[k]]))
  for (i in 1:nrow(x0List[[k]])) {
    tmp[i] <- Rastrigin(x0List[[k]][i,])
  }
  tmp
})
```

# Gaussian Process Modelling

Gaussian Process
Suppose $y_i$ is a real value, 
$Y = (y_1, \ldots, y_n) \sim MVN(\mu, \sigma^2\Psi)$, $\mu = (\mu(x_1), \ldots, \mu(x_n))^\top$ and $\sigma^2\in \mathbb{R}$, $\Psi\in \mathbb{R}^{n\times n}$



## Additive Correlation Structure with Interaction Kernel


輔助變數 $Z$ 表示階數

$$
\Psi_{st} =  \sum_{z=1}^{\min{\{z_s, z_t\}}} \sigma_z^2
\exp{\left\{
    -  \sum_{j=1}^d {
        \theta^{(z)}_j \left(x^{(z)}_{js} - x^{(z)}_{jt}\right)^2 
    }
\right\}}
$$

```{r loada, echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
source('R/aladderGP.R')
```


| 輸入變數名稱    | 說明                                                                                                   | 預設值         |
| --------------- | ------------------------------------------------------------------------------------------------------ | -------------- |
| `yList`         | R list 物件。每個 list 內存放對應階數的單維反應變數 (見範例)                                           |                |
| `xList`         | R list 物件。每個 list 內存放對應階數的多維解釋變數 (見範例)                                           |                |
| `contiParRange` | 長度為 2 的 R 向量。$\theta^{(z)}$ 的搜尋範圍(最小值、最大值)。                                        | `10^c(-3, .5)` |
| `varParRange`   | 長度為 2 的 R 向量。各 $\sigma$ 的搜尋範圍(最小值、最大值)。                                           | `10^c(-3, .5)` |
| `nSwarm`        | 正整數。PSO 粒子數，用於 likelihood 最佳化。                                                           | `64`           |
| `maxIter`       | 正整數。PSO 迭代次數，用於 likelihood 最佳化。                                                         | `200`          |
| `nugget`        | 正數。GP 相關矩陣的正定性調整值，通常為很小的數，如 `1e-8`。若輸入 `0` 則由函數自動判斷是否加上調整值。| `0.`           |
| `optVerbose`    | 是否顯示 likelihood 最佳化進度。                                                                       | `TRUE`         |



```{r aladderm, echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
aLadderMdl <- aLadderFit(yList, xList, 
                         contiParRange = 10^c(-3, .5), varParRange = 10^c(-3, .5), 
                         nSwarm = 64, maxIter = 200, nugget = 0., optVerbose = FALSE)
```



| 輸出變數名稱 | 說明                                                                                                   |
| ------------ | ------------------------------------------------------------------------------------------------------ |
| `mu`         |                                            |
| `thetaZ`     |                                            |
| `sigmaF`     |                                        |
| `sigmaInt`   |                                           |
| `psi`        |                                                      |
| `invPsi`     |                                                        |
| `negloglik`  |                                                        |
| `nugget`     | GP 相關矩陣所使用的正定性調整值 |
| `vecParams`  |                                                                       |
| `data`       |                                                                       |
| `cputime`    |                                                                       |

`r names(aLadderMdl)`


| 輸入變數名稱    | 說明                                                                                                   | 預設值         |
| --------------- | ------------------------------------------------------------------------------------------------------ | -------------- |
| `gpMdl`         | R list 物件。經 `aLadderFit` 函數訓練後的 GP 模型物件                                                  | 無             |
| `x0List`        | R list 物件。每個 list 內存放對應階數的多維解釋變數 (見範例)                                           | `NULL`         |


```{r aladderp, echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
aLadderPred(aLadderMdl, x0List)$pred
```


## Multiplicative Stage-crossing Correlation Structure

$$
\Psi_{st} = \exp{\left\{
    -\tau (z_s - z_t)^2 
    - \sum_{z=1}^{\min{\{z_s, z_t\}}} \sum_{j=1}^d {
        \theta^{(z)}_j \left(x^{(z)}_{js} - x^{(z)}_{jt}\right)^2 
    }
\right\}}
$$


$$
\Psi_{st} =  \tau_{z_s, z_t} \cdot
\exp{\left\{
    - \sum_{z=1}^{\min{\{z_s, z_t\}}} \sum_{j=1}^d {
        \theta^{(z)}_j \left(x^{(z)}_{js} - x^{(z)}_{jt}\right)^2 
    }
\right\}}
$$

```{r loadm, echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
source('R/mladderGP.R')
```



| 輸入變數名稱    | 說明                                                                                                   | 預設值         |
| --------------- | ------------------------------------------------------------------------------------------------------ | -------------- |
| `yList`         | R list 物件。每個 list 內存放對應階數的單維反應變數 (見範例)                                           |                |
| `xList`         | R list 物件。每個 list 內存放對應階數的多維解釋變數 (見範例)                                           |                |
| `zType`         | Char 物件。指定不同階數間訊息的關聯方式，`"o"`：視階數為 ordinal 變數，`"n"`：視階數為 nominal 變數。  | `"o"`          |
| `contiParRange` | 長度為 2 的 R 向量。$\theta^{(z)}$ 的搜尋範圍(最小值、最大值)。                                        | `10^c(-3, .5)` |
| `categParRange` | 長度為 2 的 R 向量。各 $\tau_{z_s, z_t}$ 的搜尋範圍(最小值、最大值)。僅適用於 `zType = "n"` 時。       | `c(0.15, 0.5)` |
| `nSwarm`        | 正整數。PSO 粒子數，用於 likelihood 最佳化。                                                           | `64`           |
| `maxIter`       | 正整數。PSO 迭代次數，用於 likelihood 最佳化。                                                         | `200`          |
| `nugget`        | 正數。GP 相關矩陣的正定性調整值，通常為很小的數，如 `1e-8`。若輸入 `0` 則由函數自動判斷是否加上調整值。| `0.`           |
| `optVerbose`    | 是否顯示 likelihood 最佳化進度。                                                                       | `TRUE`         |




```{r mladderom, echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
mLadderMdl_o <- mLadderFit(yList, xList, zType = "o", 
                           contiParRange = 10^c(-3, .5), categParRange = c(0.15, 0.5), 
                           nSwarm = 64, maxIter = 200, nugget = 0., optVerbose = FALSE)
```

```{r mladderop, echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
mLadderPred(mLadderMdl_o, x0List)$pred
```

```{r mladdernm, echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
mLadderMdl_n <- mLadderFit(yList, xList, zType = "n", 
                           contiParRange = 10^c(-3, .5), categParRange = c(0.15, 0.5), 
                           nSwarm = 64, maxIter = 200, nugget = 0., optVerbose = FALSE)
```

```{r mladdernp, echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
mLadderPred(mLadderMdl_n, x0List)$pred
```
